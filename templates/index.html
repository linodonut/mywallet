<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Please, pray my wallet!</title>
  <link rel="stylesheet" href="/static/style.css" />
  <!-- ê·¸ë˜í”„ìš© Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="page-container">
    <!-- ì™¼ìª½ ê´‘ê³  ì˜ì—­ -->
    <aside class="ad-column">
      <div class="ad-box">ê´‘ê³  ì˜ì—­ 1</div>
      <div class="ad-box">ê´‘ê³  ì˜ì—­ 2</div>
    </aside>

    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <main class="main-content">
      <header>
        <h1>Please, pray my wallet! ğŸ™</h1>
        <p>ì´ì¬í˜„ì˜ ì‹¤ì‹œê°„ ì½”ì¸ ì§€ê°‘ ìƒí™© ëŒ€ê³µê°œ</p>
      </header>

      <!-- ìš”ì•½ ì„¹ì…˜ -->
      <section id="summary-section">
        <h2>ì˜¤ëŠ˜ì˜ ì§€ê°‘ ìš”ì•½</h2>
        <div id="summary-content">
          <p>ë¡œë”© ì¤‘...</p>
        </div>
      </section>

      <!-- ì„ ë¬¼ USDT ì”ê³  + ê·¸ë˜í”„ ì„¹ì…˜ -->
      <section id="balance-section">
        <h2>ë³´ìœ  ìì‚° í˜„í™© (Binance ì„ ë¬¼ USDT)</h2>
        <p id="futures-balance-text">í˜„ì¬ ì”ê³ : ë¡œë”© ì¤‘...</p>
        <canvas id="futures-balance-chart" height="120"></canvas>
      </section>

      <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
      <section id="comment-section">
        <h2>ê¸°ë„ & í•œë§ˆë”” ë‚¨ê¸°ê¸°</h2>

        <div id="comment-form">
          <textarea id="comment-input" rows="3"
            placeholder="ì§€ê°‘ì„ ìœ„í•œ ê¸°ë„, ì¡°ì–¸, ë†€ë¦´ê±°ë¦¬(?) ë­ë“  ì¢‹ìŠµë‹ˆë‹¤. ìµëª…ìœ¼ë¡œ ë‚¨ê²¨ì ¸ìš”."></textarea>
          <button id="comment-submit">ëŒ“ê¸€ ë“±ë¡</button>
        </div>

        <ul id="comment-list">
          <li>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li>
        </ul>
      </section>

      <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
      <section id="notice-section">
        <h3>âš ï¸ ì•ˆë‚´</h3>
        <p class="disclaimer">
          ì´ ì‚¬ì´íŠ¸ì˜ ëª¨ë“  ì •ë³´ëŠ” <strong>êµìœ¡ ë° ê¸°ë¡ ëª©ì </strong>ì´ë©°,
          <strong>íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤.</strong><br />
          ìë™ë§¤ë§¤ ë° ì½”ì¸ íˆ¬ìëŠ” ëª¨ë“  ì†ìµì´ ì‚¬ìš©ì ë³¸ì¸ì—ê²Œ ê·€ì†ë©ë‹ˆë‹¤.
          ê³¼ê±° ìˆ˜ìµë¥ ì€ ë¯¸ë˜ì˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
      </section>

      <footer>
        <p>Â© 2025 Please, pray my wallet! / LeenoDonut</p>
      </footer>
    </main>

    <!-- ì˜¤ë¥¸ìª½ ê´‘ê³  ì˜ì—­ -->
    <aside class="ad-column">
      <div class="ad-box">ê´‘ê³  ì˜ì—­ 3</div>
      <div class="ad-box">ê´‘ê³  ì˜ì—­ 4</div>
    </aside>
  </div>

  <script>
    // ===== ê·¸ë˜í”„ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ =====
    let balanceChart = null;
    let balanceLabels = [];
    let balanceData = [];

    // ê·¸ë˜í”„ ìƒì„±/ì—…ë°ì´íŠ¸
    function renderOrUpdateChart() {
      const ctx = document.getElementById("futures-balance-chart").getContext("2d");

      if (!balanceChart) {
        balanceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: balanceLabels,
            datasets: [{
              label: "ì„ ë¬¼ USDT ì”ê³ ",
              data: balanceData,
              fill: false,
              tension: 0.2
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                ticks: { autoSkip: true, maxTicksLimit: 6 }
              },
              y: {
                beginAtZero: false
              }
            }
          }
        });
      } else {
        balanceChart.data.labels = balanceLabels;
        balanceChart.data.datasets[0].data = balanceData;
        balanceChart.update();
      }
    }

    // ì„œë²„ì— ì €ì¥ëœ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
    async function fetchBalanceHistory() {
      try {
        const res = await fetch("/api/balance-history");
        const data = await res.json();

        if (data.status !== "ok" || !Array.isArray(data.history)) {
          return;
        }

        balanceLabels = [];
        balanceData = [];

        data.history.forEach(point => {
          const t = new Date(point.timestamp);
          balanceLabels.push(t.toLocaleTimeString());
          balanceData.push(point.balance);
        });

        renderOrUpdateChart();
      } catch (e) {
        console.error("balance history error", e);
      }
    }

    // ìš”ì•½ ì •ë³´ (ì„ ë¬¼ USDT ì”ê³ ) + ì„œë²„ íˆìŠ¤í† ë¦¬ ê¸°ë¡ íŠ¸ë¦¬ê±°
    async function fetchSummary() {
      try {
        const res = await fetch("/api/summary");
        const data = await res.json();
        const div = document.getElementById("summary-content");

        if (data.status === "ok") {
          const s = data.summary;
          const bal = s.futures_usdt_balance;

          div.innerHTML = `
            <p>ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ: <strong>Binance ì„ ë¬¼ USDT ì§€ê°‘</strong></p>
            <p>ì„ ë¬¼ USDT ì”ê³ : <strong>${bal}</strong> USDT</p>
            <p>ìˆ˜ìµë¥ : <strong>${s.pnl_rate === null ? "ì¶”í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •" : s.pnl_rate + "%"}</strong></p>
          `;
        } else {
          div.innerHTML = `<p>ìš”ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
        }

        // summary í˜¸ì¶œ ì‹œ ì„œë²„ê°€ íˆìŠ¤í† ë¦¬ì— ìƒˆ í¬ì¸íŠ¸ë¥¼ ì¶”ê°€í–ˆìœ¼ë¯€ë¡œ,
        // ìµœì‹  íˆìŠ¤í† ë¦¬ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ ê·¸ë˜í”„ ê°±ì‹ 
        await fetchBalanceHistory();
      } catch (e) {
        document.getElementById("summary-content").innerHTML =
          `<p>ìš”ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
      }
    }

    // í˜„ì¬ ì„ ë¬¼ ì”ê³  í…ìŠ¤íŠ¸ í‘œì‹œìš© (free/locked)
    async function fetchBalance() {
      try {
        const res = await fetch("/api/balance");
        const data = await res.json();
        const text = document.getElementById("futures-balance-text");

        if (data.status === "ok" && Array.isArray(data.balances) && data.balances.length > 0) {
          const b = data.balances[0];
          text.textContent = `í˜„ì¬ ì”ê³ : ${b.total} USDT (ì‚¬ìš© ê°€ëŠ¥: ${b.free.toFixed(4)} / ì ê¹€: ${b.locked.toFixed(4)})`;
        } else {
          text.textContent = "í‘œì‹œí•  ì„ ë¬¼ ì”ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.";
        }
      } catch (e) {
        document.getElementById("futures-balance-text").textContent =
          "ì„ ë¬¼ ì”ê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    // ===== ëŒ“ê¸€ ê¸°ëŠ¥ =====
    async function fetchComments() {
      try {
        const res = await fetch("/api/comments");
        const data = await res.json();
        const list = document.getElementById("comment-list");
        list.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          const li = document.createElement("li");
          li.textContent = "ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!";
          list.appendChild(li);
          return;
        }

        data.forEach(c => {
          const li = document.createElement("li");
          const timeStr = new Date(c.created_at).toLocaleString();
          li.innerHTML = `
            <div class="comment-header">
              <strong>${c.nick}</strong>
              <span class="comment-time">${timeStr}</span>
            </div>
            <div class="comment-body">${c.content}</div>
          `;
          list.appendChild(li);
        });
      } catch (e) {
        const list = document.getElementById("comment-list");
        list.innerHTML = `<li>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>`;
      }
    }

    async function submitComment() {
      const textarea = document.getElementById("comment-input");
      const content = textarea.value.trim();
      if (!content) {
        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        const res = await fetch("/api/comments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content })
        });

        if (res.ok) {
          textarea.value = "";
          await fetchComments();
        } else {
          alert("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      } catch (e) {
        alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // ===== ì´ˆê¸° ë¡œë”© ë° ì£¼ê¸°ì  ê°±ì‹  =====
    window.addEventListener("load", () => {
      // 1) ì„œë²„ì— ìŒ“ì—¬ ìˆë˜ íˆìŠ¤í† ë¦¬ ë¨¼ì € ê·¸ë¦¬ê¸°
      fetchBalanceHistory();
      // 2) ìš”ì•½/í˜„ì¬ ì”ê³ /ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
      fetchSummary();
      fetchBalance();
      fetchComments();

      // 30ì´ˆë§ˆë‹¤ ìš”ì•½(=ì„œë²„ ë¡œê·¸ ì¶”ê°€) + ì”ê³  í…ìŠ¤íŠ¸ ê°±ì‹ 
      setInterval(() => {
        fetchSummary();
        fetchBalance();
      }, 30000);

      document
        .getElementById("comment-submit")
        .addEventListener("click", submitComment);
    });
  </script>
</body>
</html>
